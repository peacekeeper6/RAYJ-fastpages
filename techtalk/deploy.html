<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>AWS Deployment Guide | RAYJ Music</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="AWS Deployment Guide" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Description of key methods process used to deploy a Spring/Java website; AWS EC2, Docker, docker-compose, and Nginx" />
<meta property="og:description" content="Description of key methods process used to deploy a Spring/Java website; AWS EC2, Docker, docker-compose, and Nginx" />
<link rel="canonical" href="https://nighthawkcoders.github.io/RAYJ-final/techtalk/deploy" />
<meta property="og:url" content="https://nighthawkcoders.github.io/RAYJ-final/techtalk/deploy" />
<meta property="og:site_name" content="RAYJ Music" />
<meta property="og:image" content="https://nighthawkcoders.github.io/RAYJ-final/images/aws.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-09-05T00:00:00-05:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://nighthawkcoders.github.io/RAYJ-final/images/aws.png" />
<meta property="twitter:title" content="AWS Deployment Guide" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-09-05T00:00:00-05:00","datePublished":"2022-09-05T00:00:00-05:00","description":"Description of key methods process used to deploy a Spring/Java website; AWS EC2, Docker, docker-compose, and Nginx","headline":"AWS Deployment Guide","image":"https://nighthawkcoders.github.io/RAYJ-final/images/aws.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://nighthawkcoders.github.io/RAYJ-final/techtalk/deploy"},"url":"https://nighthawkcoders.github.io/RAYJ-final/techtalk/deploy"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/RAYJ-final/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://nighthawkcoders.github.io/RAYJ-final/feed.xml" title="RAYJ Music" /><link rel="shortcut icon" type="image/x-icon" href="/RAYJ-final/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/RAYJ-final/">RAYJ Music</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/RAYJ-final/quiz/overview">Quiz</a><a class="page-link" href="/RAYJ-final/https:/peacekeeper6.github.io/RAYJ-final/login">Login</a><a class="page-link" href="/RAYJ-final/https:/peacekeeper6.github.io/RAYJ-final/api">API</a><a class="page-link" href="/RAYJ-final/https:/peacekeeper6.github.io/RAYJ-final/search/">Search</a><a class="page-link" href="/RAYJ-final/https:/peacekeeper6.github.io/RAYJ-final/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">AWS Deployment Guide</h1><p class="page-description">Description of key methods process used to deploy a Spring/Java website; AWS EC2, Docker, docker-compose, and Nginx</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-09-05T00:00:00-05:00" itemprop="datePublished">
        Sep 5, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      20 min read
    
</span></p>

    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#deployment-overview">Deployment Overview</a>
<ul>
<li class="toc-entry toc-h3"><a href="#keyvalues-required-as-you-go-through-these-procedures">Key/Values required as you go through these procedures</a></li>
<li class="toc-entry toc-h3"><a href="#amazon-web-services-aws-electric-cloud-compute-ec2-setup">Amazon Web Services (AWS): Electric Cloud Compute (EC2) Setup</a></li>
<li class="toc-entry toc-h3"><a href="#install-packages">Install packages</a>
<ul>
<li class="toc-entry toc-h4"><a href="#updateupgrade-all-packages-on-your-ec2">Update/Upgrade all packages on your EC2</a></li>
<li class="toc-entry toc-h4"><a href="#install-java-runtime-environment">Install Java Runtime Environment</a></li>
<li class="toc-entry toc-h4"><a href="#install-java-development-kit">Install Java Development Kit</a></li>
<li class="toc-entry toc-h4"><a href="#maven-is-required-to-build-project">Maven is required to build project</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#clone-and-change-directory-to-project-location">Clone and Change Directory to project location</a></li>
<li class="toc-entry toc-h3"><a href="#build-the-web-service">Build the Web Service</a></li>
<li class="toc-entry toc-h3"><a href="#create-dockerfile-to-run-web-service">Create Dockerfile to run Web Service</a></li>
<li class="toc-entry toc-h3"><a href="#create-docker-compose-file-share-web-service">Create docker-compose file share Web Service</a></li>
<li class="toc-entry toc-h3"><a href="#running-docker-using-docker-composeyml">Running Docker using docker-compose.yml</a></li>
<li class="toc-entry toc-h3"><a href="#verifying-web-application-via-docker-commands">Verifying Web Application via Docker commands</a></li>
<li class="toc-entry toc-h3"><a href="#preparing-the-docker-web-application-for-internet-access">Preparing the Docker Web Application for Internet Access</a>
<ul>
<li class="toc-entry toc-h4"><a href="#dns-provider-and-setup">DNS provider and setup</a></li>
<li class="toc-entry toc-h4"><a href="#nginx-install-configuration-and-services">Nginx install, configuration, and services</a></li>
<li class="toc-entry toc-h4"><a href="#testing-http-endpoint">Testing HTTP endpoint</a></li>
<li class="toc-entry toc-h4"><a href="#certbot-install-and-configuration">Certbot install and configuration</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#update-deployment">Update Deployment</a>
<ul>
<li class="toc-entry toc-h3"><a href="#goto-project-directory">Goto Project directory</a></li>
<li class="toc-entry toc-h3"><a href="#shutdown-process-and-update-source">Shutdown process and update source</a></li>
<li class="toc-entry toc-h3"><a href="#rebuild-and-restart-web-application">Rebuild and Restart Web Application</a></li>
<li class="toc-entry toc-h3"><a href="#setting-up-automatic-deployment">Setting up automatic deployment</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#faqs-for-problems">FAQS for Problems</a>
<ul>
<li class="toc-entry toc-h3"><a href="#setting-up-docker-without-sudo">Setting up docker without sudo</a></li>
<li class="toc-entry toc-h3"><a href="#errors-on-docker-compose-or-curl">Errors on docker-compose or curl</a></li>
</ul>
</li>
</ul><h2 id="deployment-overview">
<a class="anchor" href="#deployment-overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Deployment Overview</h2>
<p>Deploying a Web Application enables a Server to serve the components of a Web Application to clients. Deployment is the tools and service used to enable the Web Application on the Internet.  The process of can use many different cloud servers, as well as choice in tools and services.</p>

<ul>
  <li>EC2: Amazon Web Services is a cloud computing platform that the PUSD district has provided for us to serve our Web Application.</li>
  <li>GitHub: At this point in time, we should be aware that we are using GitHub is an open platform to share our Web Application code on the Internet.</li>
  <li>Docker and docker-compose: To host a Web Application you need to prepare an environment that contains the Web Application code and all the dependencies (POM.xml for Java)  Docker is an open platform for developing, shipping, and running applications.</li>
  <li>Nginx: To find a Web Application on a server, there needs to be a process to listen for the Web request and direct it to the Web Application.  Nginx is an open source software for web serving, reverse proxy, caching, load balancing, media streaming, and more.</li>
  <li>Certbot: Web traffic on internet is reliably served over Secure Hyper Text Transfer Protocol (https).  Certbot is a free, open source software tool for automatically using Let’s Encrypt certifications</li>
  <li>DNS: Natively, the web works off of IP addresses.  Domain Name Services (DNS) allows the assignment of a friendly name to our Web Server.  This name is built into Nginx/Certbot configuration files.  Freenom is the service used to register the nighthawkcodingsociety.com domain.</li>
</ul>

<h3 id="keyvalues-required-as-you-go-through-these-procedures">
<a class="anchor" href="#keyvalues-required-as-you-go-through-these-procedures" aria-hidden="true"><span class="octicon octicon-link"></span></a>Key/Values required as you go through these procedures</h3>
<p>Listed are Keys, you need to obtain Values.  It is important that you recognize the sample Values as you work through these procedures, then replace them with the Values that are specific to your use case.</p>

<ul>
  <li>GitHub HTTPS link:</li>
  <li>IAM user:</li>
  <li>EC2 name:</li>
  <li>EC2 Public IPs:</li>
  <li>DNS Name:</li>
  <li>DNS Subdomain name(s)</li>
  <li>Docker Port:</li>
  <li>docker-compose, proxy pass Port:</li>
  <li>docker-compose, docker Image:</li>
  <li>Nginx server file(s):</li>
</ul>

<h3 id="amazon-web-services-aws-electric-cloud-compute-ec2-setup">
<a class="anchor" href="#amazon-web-services-aws-electric-cloud-compute-ec2-setup" aria-hidden="true"><span class="octicon octicon-link"></span></a>Amazon Web Services (AWS): Electric Cloud Compute (EC2) Setup</h3>
<p>Preparing and AWS EC2 instance is the process of creating a cloud computer.  This process starts by logging into your AWS IAM user, searching for EC2.</p>
<ul>
  <li>To get started, launch a new AWS EC2 instance to learn process and understand how to work with Linux. here are some key considerations.
    <ul>
      <li>Choose an Amazon Machine Image (AMI), the class will be using Ubuntu you should check on last verified version with a Teacher before proceeding</li>
      <li>When it comes to picking memory or disk it is VERY important to pick Free Tier.  As stated, this will only be used for testing and then it will be disposed for cost efficiency.</li>
      <li>When presented with access dialog for http and https, make sure you check these boxes.  Remember you are making a Web application that will run over http and https.</li>
      <li>Name the security group (.pem) file after your team.  It may be necessary to use SSH to access your EC2 instance.</li>
      <li>The remainder of the steps you can use the defaults, refer to AWS documentation for guidance: https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EC2_GetStarted.html</li>
      <li>At the end of this process you need to “Connect to Instance”. This will provide you a terminal like experience.</li>
    </ul>
  </li>
</ul>

<h3 id="install-packages">
<a class="anchor" href="#install-packages" aria-hidden="true"><span class="octicon octicon-link"></span></a>Install packages</h3>
<p>Terminal commands are shown, these commands will be run from Terminal after you connect to your EC2 name.</p>

<h4 id="updateupgrade-all-packages-on-your-ec2">
<a class="anchor" href="#updateupgrade-all-packages-on-your-ec2" aria-hidden="true"><span class="octicon octicon-link"></span></a>Update/Upgrade all packages on your EC2</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>apt update<span class="p">;</span> <span class="nb">sudo </span>apt upgrade
</code></pre></div></div>

<h4 id="install-java-runtime-environment">
<a class="anchor" href="#install-java-runtime-environment" aria-hidden="true"><span class="octicon octicon-link"></span></a>Install Java Runtime Environment</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install </span>default-jre
<span class="nv">$ </span>java <span class="nt">-version</span>
</code></pre></div></div>

<h4 id="install-java-development-kit">
<a class="anchor" href="#install-java-development-kit" aria-hidden="true"><span class="octicon octicon-link"></span></a>Install Java Development Kit</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install </span>default-jdk
<span class="nv">$ </span>javac <span class="nt">-version</span>
</code></pre></div></div>

<h4 id="maven-is-required-to-build-project">
<a class="anchor" href="#maven-is-required-to-build-project" aria-hidden="true"><span class="octicon octicon-link"></span></a>Maven is required to build project</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>apt update
<span class="nv">$ </span><span class="nb">sudo </span>apt upgrade
<span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install </span>maven
<span class="nv">$ </span>mvn <span class="nt">-version</span>
</code></pre></div></div>

<h3 id="clone-and-change-directory-to-project-location">
<a class="anchor" href="#clone-and-change-directory-to-project-location" aria-hidden="true"><span class="octicon octicon-link"></span></a>Clone and Change Directory to project location</h3>
<p>These commands move your Web Application code onto you EC2 cloud computer</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd</span>
<span class="nv">$ </span>git clone https://github.com/nighthawkcoders/spring_portfolio.git
</code></pre></div></div>

<h3 id="build-the-web-service">
<a class="anchor" href="#build-the-web-service" aria-hidden="true"><span class="octicon octicon-link"></span></a>Build the Web Service</h3>
<p>These steps will require you test Maven build prior to the final deployment process.</p>

<ul>
  <li>Maven Build and Jar package command
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd</span> ~/spring_portfolio
<span class="nv">$ </span>./mvnw package
</code></pre></div>    </div>

    <ul>
      <li>If Maven fails, try this and repeat Maven command
        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> dos2unix
<span class="nv">$ </span>dos2unix ./mvnw
<span class="nv">$ </span><span class="nb">chmod</span> +x ./mvnw
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>Run Java Application
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd</span> ~/spring_portfolio
<span class="nv">$ </span>java <span class="nt">-jar</span> target/spring-0.0.1-SNAPSHOT.jar
</code></pre></div>    </div>
  </li>
  <li>At this point we will type ctrl+c as we will now run a Docker File to do this step</li>
</ul>

<h3 id="create-dockerfile-to-run-web-service">
<a class="anchor" href="#create-dockerfile-to-run-web-service" aria-hidden="true"><span class="octicon octicon-link"></span></a>Create Dockerfile to run Web Service</h3>
<p>A Dockerfile is a configuration used to run the Web Service.  This is placed in a file called Dockerfile.  It is best to add this to VS Code and pull it, or you can update in place with nano, vi, or vim editor and use command line commands to push it into your repository.  The Dockerfile should be considered Code!</p>
<ul>
  <li>Edit the Dockerfile
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nano Dockerfile
</code></pre></div>    </div>
  </li>
  <li>Insert the Dockerfile commands, note that they are similar to Bash commands performed earlier.  Follow prompts on screen to save file when complete, look for Key/Value (GitHub HTTPS link) that requires change for your project.
    <div class="language-dockerfile highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># syntax=docker/dockerfile:1</span>
<span class="k">FROM</span><span class="s"> openjdk:16-alpine3.13</span>
<span class="k">WORKDIR</span><span class="s"> /app</span>
<span class="k">RUN </span>apk update <span class="o">&amp;&amp;</span> apk upgrade <span class="o">&amp;&amp;</span> <span class="se">\
</span>  apk add <span class="nt">--no-cache</span> git maven
<span class="k">COPY</span><span class="s"> . /app</span>
<span class="k">RUN </span>./mvnw package
<span class="k">CMD</span><span class="s"> ["java", "-jar", "target/spring-0.0.1-SNAPSHOT.jar"]</span>
<span class="c"># EXPOSE port that is defined in spring_portfolio.git application.properties</span>
<span class="k">EXPOSE</span><span class="s"> 8085  </span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="create-docker-compose-file-share-web-service">
<a class="anchor" href="#create-docker-compose-file-share-web-service" aria-hidden="true"><span class="octicon octicon-link"></span></a>Create docker-compose file share Web Service</h3>
<p>A docker-compose file is a configuration used to share your Docker Web Service and resources with the Linux system.  This file enable Linux to have access to the container and the persistent data application via the /volumes location.</p>

<p>Once again it is best to add the docker-compose.yml in VS Code and pull it.  You can edit it on the machine itself using vi, vim, or nano.</p>
<ul>
  <li>Edit docker-compose.yml
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nano docker-compose.yml
</code></pre></div>    </div>
  </li>
  <li>Change the docker-compose.yml Keys/Values.
    <ul>
      <li>ports 8085:nnnn - Left 8085 is port to be used on system, by curl and Nginx config.</li>
      <li>ports nnnn:8085 - Right 8085 is port exposed by Docker: EXPOSE 8085</li>
      <li>device /home/ubuntu/spring_portfolio/volumes - is my project defining a volumes directory for database and uploads outside of container
```yml
version: ‘3’
services:
web:
  image: java_springv1
  build: .
  ports:
        <ul>
          <li>“8085:8085”
volumes:</li>
          <li>persistent_volume:/app/volumes
volumes:
persistent_volume:
driver: local
driver_opts:
o: bind
type: none
device: /home/ubuntu/spring_portfolio/volumes
```</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>IF you cloned the repository after 9/8 you may have to change ports to 8085:8085</p>

<h3 id="running-docker-using-docker-composeyml">
<a class="anchor" href="#running-docker-using-docker-composeyml" aria-hidden="true"><span class="octicon octicon-link"></span></a>Running Docker using docker-compose.yml</h3>
<p>At this point, it is best to review complete files on GitHub and for Docker and docker-compose: https://github.com/nighthawkcoders/spring_portfolio.   Review the Key/Values mentioned in this document.  Make sure your Docker and docker-compose files a personalized to your project.</p>

<ul>
  <li>Make sure you are in project directory
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd</span> ~/spring_portfolio/
</code></pre></div>    </div>
  </li>
  <li>install docker-compose
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install </span>docker-compose <span class="nt">-y</span>
</code></pre></div>    </div>
  </li>
  <li>Run docker-compose
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>docker-compose up <span class="nt">-d</span>
</code></pre></div>    </div>
  </li>
  <li>Output from docker-compose.  When running this command, docker-compose will run all the Docker steps and build a Web Application running in a Docker container, a virtual environment.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Creating network <span class="s2">"spring_portfolio_default"</span> with the default driver
Building web
Step 1/9 : FROM openjdk:16-alpine3.13
 <span class="nt">---</span><span class="o">&gt;</span> d0ce03c9330c
Step 2/9 : WORKDIR /app

.... LOTS of STEPs and OUTPUT ...

Successfully built 68d68ad9699b
Successfully tagged ava_springv1:latest
WARNING: Image <span class="k">for </span>service web was built because it did not already exist. To rebuild this image you must use <span class="sb">`</span>docker-compose build<span class="sb">`</span> or <span class="sb">`</span>docker-compose up <span class="nt">--build</span><span class="sb">`</span><span class="nb">.</span>
Creating flask_portfolio_web_1 ... <span class="k">done</span>
</code></pre></div></div>

<h3 id="verifying-web-application-via-docker-commands">
<a class="anchor" href="#verifying-web-application-via-docker-commands" aria-hidden="true"><span class="octicon octicon-link"></span></a>Verifying Web Application via Docker commands</h3>
<p>Here is a look at some of the commands behind the scenes.  None of these are required to get things working, but show the results of the Docker and docker-compose.yml files and commands.</p>

<ul>
  <li>docker-compose ps   The running Web process, “ps” is a linux command or option that provides information related to the processes on a system.  Look at headings in relation to outputs of the docker-compose process.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> ubuntu@ip-172-31-1-138:~/flask_portfolio<span class="nv">$ </span>docker-compose ps
      Name                 Command        State                    Ports                  
<span class="nt">--------------------------------------------------------------------------------------------</span>
ava_springv1           gunicorn main:app   Up      0.0.0.0:8085-&gt;8080/tcp,:::8085-&gt;8080/tcp
</code></pre></div>    </div>
  </li>
  <li>docker ps   A more comprehensive list of all the docker processes on the system.  In this process reports, many of the alternate projects running on this AWS server are show.  The flask_portfolio_web_1 process is the items specific to this tutorial.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>buntu@ip-172-31-1-138:~/flask_portfolio<span class="nv">$ </span>docker ps
CONTAINER ID   IMAGE           COMMAND                  CREATED          STATUS          PORTS                                       NAMES
749a93bc11ce   flask_port_v1   <span class="s2">"gunicorn main:app"</span>      45 minutes ago   Up 45 minutes   0.0.0.0:8086-&gt;8080/tcp, :::8086-&gt;8080/tcp   flask_portfolio_web_1
89155782b853   java_springv1   <span class="s2">"java -jar target/sp…"</span>   6 days ago       Up 6 days       0.0.0.0:8085-&gt;8080/tcp, :::8085-&gt;8080/tcp   spring_portfolio_web_1
9415d6397d2e   python_cspv1    <span class="s2">"gunicorn main:app"</span>      2 weeks ago      Up 2 weeks      0.0.0.0:8082-&gt;8080/tcp, :::8082-&gt;8080/tcp   nighthawk_csp_web_1
4bf324458bf6   python_laxv1    <span class="s2">"gunicorn main:app"</span>      5 weeks ago      Up 5 weeks      0.0.0.0:8084-&gt;8080/tcp, :::8084-&gt;8080/tcp   lax_web_1
7a6dff6425e9   python_ctev1    <span class="s2">"gunicorn main:app"</span>      5 weeks ago      Up 5 weeks      0.0.0.0:8083-&gt;8080/tcp, :::8083-&gt;8080/tcp   cte_web_1
abd77b8e77af   java_csav2      <span class="s2">"java -jar target/cs…"</span>   5 weeks ago      Up 5 weeks      0.0.0.0:8081-&gt;8080/tcp, :::8081-&gt;8080/tcp   nighthawk_csa_web_1
</code></pre></div>    </div>
  </li>
  <li>docker images   This lists all of the docker images, or containers, that are used to serve the process shown above.  The flask_port_v1 is the image created from the Docker file created in this tutorial.  The image contains the running Web application.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>ubuntu@ip-172-31-1-138:~/flask_portfolio<span class="nv">$ </span>docker images
REPOSITORY      TAG             IMAGE ID       CREATED          SIZE
flask_port_v1   latest          68d68ad9699b   51 minutes ago   1.01GB
java_springv1   latest          e85a584b1836   6 days ago       523MB
python_laxv1    latest          713c84a30d3b   5 weeks ago      1.16GB
python_ctev1    latest          1608eaee06c7   5 weeks ago      1.18GB
python_cspv1    latest          b9bb27be863b   5 weeks ago      1.12GB
java_csav2      latest          4055a9fd5ea7   5 weeks ago      570MB
python          3.9             d0ce03c9330c   7 weeks ago      915MB
alpine          latest          e66264b98777   8 weeks ago      5.53MB
openjdk         16-alpine3.13   2aa8569968b8   17 months ago    324MB
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="preparing-the-docker-web-application-for-internet-access">
<a class="anchor" href="#preparing-the-docker-web-application-for-internet-access" aria-hidden="true"><span class="octicon octicon-link"></span></a>Preparing the Docker Web Application for Internet Access</h3>
<p>There are a couple of steps to this preparation. We need to direct the internet to the Server running the Web Application, this is done using Domain Name Service (DNS).   After being directed to the Web Server, the server needs to respond to the Hyper Text Transfer Protocol (HTTP), this will be manged by Nginx.   Additionally, we will be required to support Secure HTTP (HTTPS), a utility called Certbot will augment our Nginx configuration with a certificate.</p>

<h4 id="dns-provider-and-setup">
<a class="anchor" href="#dns-provider-and-setup" aria-hidden="true"><span class="octicon octicon-link"></span></a>DNS provider and setup</h4>
<p>Each student scrum team is required to learn how to obtain a DNS provider and setup an independent domain.  However, the final set up will be using a Subdomain under nighthawkcodingsociety.com.</p>

<p>A picture is included to show key elements in setting up a domain with a DNS provider.  The nighthawkcodingsociety.com is using Freenom as its service provider.  As you build your own DNS server you will need to obtain your own IP address and domain.</p>

<p>This illustration is dependent on…</p>
<ul>
  <li>EC2 Public IPs: 3.233.212.71</li>
  <li>Docker Compose Port: 8085</li>
  <li>DNS Name: nighthawkcodingsociety.com</li>
  <li>DNS Subdomain name(s): battleship.nighthawkcodingsociety.com. cowboys.nighthawkcodingsociety.com</li>
</ul>

<p>A minimum configuration will have the two “A” type definitions using you Public IP address.  These two are resolved with a single Web Application.  The “CNAME” type is used for subdomains, these will resolve to a different Web Application.</p>

<p><img alt="Setup a Domain" src="/RAYJ-final/images/freenom.png" title="DNS Provider"></p>

<h4 id="nginx-install-configuration-and-services">
<a class="anchor" href="#nginx-install-configuration-and-services" aria-hidden="true"><span class="octicon octicon-link"></span></a>Nginx install, configuration, and services</h4>
<p>Each student scrum team will perform Nginx installation and setup on an AWS EC2 test server.  The final configuration will be on AWS server managed by Teachers or Student DevOps Engineers.</p>

<p>Enable Nginx to retrieve Java Web Application on internet request (Reverse Proxy)! Make a server file located at /etc/nginx/sites-available/nighthawk.</p>

<ul>
  <li>Install Nginx on Ubuntu servers
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install </span>nginx
</code></pre></div>    </div>
  </li>
  <li>Go to location of Nginx server configuration files
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd</span> /etc/nginx/sites-available
</code></pre></div>    </div>
  </li>
  <li>Open editor to Create your own “Nginx server configuration”
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nano nighthawk
</code></pre></div>    </div>
  </li>
  <li>Edit your own Nginx server configuration making modifications to <mark>primary server</mark> file (1 required):
    <ul>
      <li>DNS Name(s): nighthawkcodingsociety.com www.nighthawkcodingsociety.com</li>
      <li>docker-compose, proxy pass Port: 8085</li>
    </ul>
  </li>
</ul>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
    <span class="kn">listen</span> <span class="s">[::]:80</span><span class="p">;</span>
    <span class="kn">server_name</span> <span class="s">nighthawkcodingsociety.com</span> <span class="s">www.nighthawkcodingsociety.com</span><span class="p">;</span>

    <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span>
        <span class="kn">proxy_pass</span> <span class="s">http://localhost:8085</span><span class="p">;</span>
        <span class="c1"># Simple requests</span>
        <span class="kn">if</span> <span class="s">(</span><span class="nv">$request_method</span> <span class="p">~</span><span class="sr">*</span> <span class="s">"(GET|POST)")</span> <span class="p">{</span>
                <span class="kn">add_header</span> <span class="s">"Access-Control-Allow-Origin"</span>  <span class="s">*</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1"># Preflight requests</span>
        <span class="kn">if</span> <span class="s">(</span><span class="nv">$request_method</span> <span class="p">=</span> <span class="s">OPTIONS</span> <span class="s">)</span> <span class="p">{</span>
                <span class="kn">add_header</span> <span class="s">"Access-Control-Allow-Origin"</span>  <span class="s">*</span><span class="p">;</span>
                <span class="kn">add_header</span> <span class="s">"Access-Control-Allow-Methods"</span> <span class="s">"GET,</span> <span class="s">POST,</span> <span class="s">OPTIONS,</span> <span class="s">HEAD"</span><span class="p">;</span>
                <span class="kn">add_header</span> <span class="s">"Access-Control-Allow-Headers"</span> <span class="s">"Authorization,</span> <span class="s">Origin,</span> <span class="s">X-Requested-With,</span> <span class="s">Content-Type,</span> <span class="s">Accept"</span><span class="p">;</span>
                <span class="kn">return</span> <span class="mi">200</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Or, or in addition, edit your own Nginx server configuration making modifications to <mark>subdomain</mark> file (0 to many):
    <ul>
      <li>DNS Name(s): spring.nighthawkcodingsociety.com</li>
      <li>docker-compose, proxy pass Port: 8085</li>
    </ul>
  </li>
</ul>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
    <span class="kn">listen</span> <span class="s">[::]:80</span><span class="p">;</span>
    <span class="kn">server_name</span> <span class="s">spring.nighthawkcodingsociety.com</span><span class="p">;</span>

    <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span>
        <span class="kn">proxy_pass</span> <span class="s">http://localhost:8085</span><span class="p">;</span>
        <span class="c1"># Simple requests</span>
        <span class="kn">if</span> <span class="s">(</span><span class="nv">$request_method</span> <span class="p">~</span><span class="sr">*</span> <span class="s">"(GET|POST|PUT)")</span> <span class="p">{</span>
                <span class="kn">add_header</span> <span class="s">"Access-Control-Allow-Origin"</span>  <span class="s">*</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1"># Preflight requests</span>
        <span class="kn">if</span> <span class="s">(</span><span class="nv">$request_method</span> <span class="p">=</span> <span class="s">OPTIONS</span> <span class="s">)</span> <span class="p">{</span>
                <span class="kn">add_header</span> <span class="s">"Access-Control-Allow-Origin"</span>  <span class="s">*</span><span class="p">;</span>
                <span class="kn">add_header</span> <span class="s">"Access-Control-Allow-Methods"</span> <span class="s">"GET,</span> <span class="s">POST,</span> <span class="s">OPTIONS,</span> <span class="s">PUT,</span> <span class="s">HEAD"</span><span class="p">;</span>
                <span class="kn">add_header</span> <span class="s">"Access-Control-Allow-Headers"</span> <span class="s">"Authorization,</span> <span class="s">Origin,</span> <span class="s">X-Requested-With,</span> <span class="s">Content-Type,</span> <span class="s">Accept"</span><span class="p">;</span>
                <span class="kn">return</span> <span class="mi">200</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Activate/enabled Nginx server configuration:
    <ul>
      <li>nginx configuration file: nighthawk</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo ln</span> <span class="nt">-s</span> /etc/nginx/sites-available/nighthawk /etc/nginx/sites-enabled
<span class="nv">$ </span><span class="nb">sudo </span>nginx <span class="nt">-t</span>
</code></pre></div></div>

<ul>
  <li>If there are no errors, restart NGINX so the server is an endpoint to the internet:
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>systemctl restart nginx
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="testing-http-endpoint">
<a class="anchor" href="#testing-http-endpoint" aria-hidden="true"><span class="octicon octicon-link"></span></a>Testing HTTP endpoint</h4>
<p>Before finishing, this is a good opportunity to test everything you have done.</p>

<ul>
  <li>Direct Test of Web Application Endpoint.  This should return HTML related to the home page of the Web site.  If this fails, you need to review Docker and docker-compose configurations.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://localhost:8085<span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>Testing unsecure HTTP endpoint on the internet.  Go to a browser an type your DNS domain: <code class="language-plaintext highlighter-rouge">http://nighthawkcodingsociety.com</code>.
    <ul>
      <li>Timeout.  This means something is wrong with EC2 Public IP.</li>
      <li>Nginx Default page.  This means DNS is working, but something is wrong with you Nginx configuration.</li>
      <li>Broken Gateway.  This means Nginx is working, but something is wrong with Web Application endpoint on machine, if this fails something is wrong with Web Application.  This requires you to look at Docker and docker-compose configuration.</li>
    </ul>
  </li>
</ul>

<h4 id="certbot-install-and-configuration">
<a class="anchor" href="#certbot-install-and-configuration" aria-hidden="true"><span class="octicon octicon-link"></span></a>Certbot install and configuration</h4>
<p>Each student scrum team will learn Certbot on on AWS EC2 test server, establish working https web application.  The final configuration will be on AWS server managed by Teachers or Student DevOps Engineers.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>snap <span class="nb">install </span>core<span class="p">;</span> <span class="nb">sudo </span>snap refresh core
<span class="nv">$ </span><span class="nb">sudo </span>snap <span class="nb">install</span> <span class="nt">--classic</span> certbot
<span class="nv">$ </span><span class="nb">sudo ln</span> <span class="nt">-s</span> /snap/bin/certbot /usr/bin/certbot
<span class="nv">$ </span><span class="nb">sudo </span>certbot <span class="nt">--nginx</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Saving debug log to /var/log/letsencrypt/letsencrypt.log
Plugins selected: Authenticator nginx, Installer nginx

Which names would you like to activate HTTPS for?
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
1: nighthawkcodingsociety.com
2: csa.nighthawkcodingsociety.com
3: csp.nighthawkcodingsociety.com
4: flm.nighthawkcodingsociety.com
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Select the appropriate numbers separated by commas and/or spaces, or leave input
blank to select all options shown (Enter 'c' to cancel):    
Cert not yet due for renewal

You have an existing certificate that has exactly the same domains or certificate name you requested and isn't close to expiry.
(ref: /etc/letsencrypt/renewal/nighthawkcodingsociety.com-0001.conf)

What would you like to do?
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
1: Attempt to reinstall this existing certificate
2: Renew &amp; replace the cert (limit ~5 per 7 days)
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Select the appropriate number [1-2] then [enter] (press 'c' to cancel): 2
Renewing an existing certificate
Performing the following challenges:
http-01 challenge for nighthawkcodingsociety.com
http-01 challenge for csa.nighthawkcodingsociety.com
http-01 challenge for cso.nighthawkcodingsociety.com
http-01 challenge for flm.nighthawkcodingsociety.com
Waiting for verification...
Cleaning up challenges
Deploying Certificate to VirtualHost /etc/nginx/sites-enabled/nighthawk_society
Deploying Certificate to VirtualHost /etc/nginx/sites-enabled/nighthawk_csa
Deploying Certificate to VirtualHost /etc/nginx/sites-enabled/nighthawk_csp
Deploying Certificate to VirtualHost /etc/nginx/sites-enabled/nighthawk_flm

Please choose whether or not to redirect HTTP traffic to HTTPS, removing HTTP access.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
1: No redirect - Make no further changes to the webserver configuration.
2: Redirect - Make all requests redirect to secure HTTPS access. Choose this for
new sites, or if you're confident your site works on HTTPS. You can undo this
change by editing your web server's configuration.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Select the appropriate number [1-2] then [enter] (press 'c' to cancel): 2
Traffic on port 80 already redirecting to ssl in /etc/nginx/sites-enabled/nighthawk_society
Traffic on port 80 already redirecting to ssl in /etc/nginx/sites-enabled/nighthawk_csa
Traffic on port 80 already redirecting to ssl in /etc/nginx/sites-enabled/nighthawk_csp
Traffic on port 80 already redirecting to ssl in /etc/nginx/sites-enabled/nighthawk_flm

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Your existing certificate has been successfully renewed, and the new certificate
has been installed.

The new certificate covers the following domains:
https://nighthawkcodingsociety.com, 
https://csa.nighthawkcodingsociety.com, 
https://csp.nighthawkcodingsociety.com, and
https://flm.nighthawkcodingsociety.com,

You should test your configuration at:
https://www.ssllabs.com/ssltest/analyze.html?d=nighthawkcodingsociety.com
https://www.ssllabs.com/ssltest/analyze.html?d=csa.nighthawkcodingsociety.com
https://www.ssllabs.com/ssltest/analyze.html?d=csp.nighthawkcodingsociety.com
https://www.ssllabs.com/ssltest/analyze.html?d=flm.nighthawkcodingsociety.com
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at:
   /etc/letsencrypt/live/nighthawkcodingsociety.com-0001/fullchain.pem
   Your key file has been saved at:
   /etc/letsencrypt/live/nighthawkcodingsociety.com-0001/privkey.pem
   Your cert will expire on 2022-03-06. To obtain a new or tweaked
   version of this certificate in the future, simply run certbot again
   with the "certonly" option. To non-interactively renew *all* of
   your certificates, run "certbot renew"
 - If you like Certbot, please consider supporting our work by:

   Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
   Donating to EFF:                    https://eff.org/donate-le
</code></pre></div></div>

<p>After this is complete, Let’s Encrypt can be set up to renew certificates if expring within 30 days. This is accomplished using cron jobs (periodic jobs). In this case, we will run the job daily which checks &amp; updates the certificates</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>crontab -e # edit crontab file

0 12 * * * /usr/bin/certbot renew --quiet # add this line to the file (runs renew daily)
</code></pre></div></div>

<h2 id="update-deployment">
<a class="anchor" href="#update-deployment" aria-hidden="true"><span class="octicon octicon-link"></span></a>Update Deployment</h2>
<blockquote>
  <p>This procedure is a very short, as much of the deployment performed is persistent on your EC2/Ubuntu.</p>
</blockquote>

<h3 id="goto-project-directory">
<a class="anchor" href="#goto-project-directory" aria-hidden="true"><span class="octicon octicon-link"></span></a>Goto Project directory</h3>

<blockquote>
  <p>Check your docker processes.  Make sure git has nothing to commit.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd</span> ~/spring_portfolio/
<span class="nv">$ </span>docker-compose ps
         Name                       Command               State                    Ports                  
<span class="nt">----------------------------------------------------------------------------------------------------------</span>
spring_portfolio_web_1   java <span class="nt">-jar</span> target/spring-0. ...   Up      0.0.0.0:8085-&gt;8080/tcp,:::8085-&gt;8080/tcp

<span class="nv">$ </span>docker ps
CONTAINER ID   IMAGE           COMMAND                  CREATED        STATUS        PORTS                                       NAMES
89155782b853   java_springv1   <span class="s2">"java -jar target/sp…"</span>   8 weeks ago    Up 8 weeks    0.0.0.0:8085-&gt;8080/tcp, :::8085-&gt;8080/tcp   spring_portfolio_web_1

<span class="nv">$ </span>git status
On branch master
Your branch is up to <span class="nb">date </span>with <span class="s1">'origin/master'</span><span class="nb">.</span>

nothing to commit, working tree clean
</code></pre></div></div>

<h3 id="shutdown-process-and-update-source">
<a class="anchor" href="#shutdown-process-and-update-source" aria-hidden="true"><span class="octicon octicon-link"></span></a>Shutdown process and update source</h3>

<blockquote>
  <p>Stop docker processes and git pull</p>
  <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose <span class="nb">kill
</span>Killing spring_portfolio_web_1 ... <span class="k">done</span>
</code></pre></div>  </div>
</blockquote>

<blockquote>
  <p>At this point your server is down, look at it from browser</p>
  <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>502 Bad Gateway
</code></pre></div>  </div>
</blockquote>

<blockquote>
  <p>Update code</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ubuntu@ip-172-31-1-138:~/spring_portfolio<span class="nv">$ </span>git pull
remote: Enumerating objects: 11, <span class="k">done</span><span class="nb">.</span>
remote: Counting objects: 100% <span class="o">(</span>11/11<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Compressing objects: 100% <span class="o">(</span>3/3<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Total 6 <span class="o">(</span>delta 2<span class="o">)</span>, reused 6 <span class="o">(</span>delta 2<span class="o">)</span>, pack-reused 0
Unpacking objects: 100% <span class="o">(</span>6/6<span class="o">)</span>, 562 bytes | 562.00 KiB/s, <span class="k">done</span><span class="nb">.</span>
From https://github.com/nighthawkcoders/spring_portfolio
   c308ee0..c1f06f1  master     -&gt; origin/master
Updating c308ee0..c1f06f1
Fast-forward
 src/main/resources/application.properties | 4 +++-
 1 file changed, 3 insertions<span class="o">(</span>+<span class="o">)</span>, 1 deletion<span class="o">(</span>-<span class="o">)</span>
</code></pre></div></div>

<h3 id="rebuild-and-restart-web-application">
<a class="anchor" href="#rebuild-and-restart-web-application" aria-hidden="true"><span class="octicon octicon-link"></span></a>Rebuild and Restart Web Application</h3>

<blockquote>
  <p>Force rebuild of docker container.  This will take several minutes.</p>
</blockquote>

<ul>
  <li>Note.  There is extra opportunity here, for a better way, to do this by using cache and having github pull outside of container (volume?)</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose build <span class="nt">--no-cache</span>  <span class="c"># this will take several minutes</span>
Building web
Step 1/7 : FROM openjdk:16-alpine3.13
 <span class="nt">---</span><span class="o">&gt;</span> 2aa8569968b8
Step 2/7 : WORKDIR /app
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>327ed1c61755
Removing intermediate container 327ed1c61755
 <span class="nt">---</span><span class="o">&gt;</span> 3769ad96350d
Step 3/7 : RUN apk update <span class="o">&amp;&amp;</span> apk upgrade <span class="o">&amp;&amp;</span>     apk add <span class="nt">--no-cache</span> git
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>76646a4afae0

 ... Lots of Output ...

Downloaded from central: https://repo.maven.apache.org/maven2/org/codehaus/plexus/plexus-utils/3.2.1/plexus-utils-3.2.1.jar <span class="o">(</span>262 kB at 246 kB/s<span class="o">)</span>
Downloaded from central: https://repo.maven.apache.org/maven2/org/eclipse/sisu/org.eclipse.sisu.inject/0.3.4/org.eclipse.sisu.inject-0.3.4.jar <span class="o">(</span>379 kB at 350 kB/s<span class="o">)</span>
<span class="o">[</span>INFO] Replacing main artifact with repackaged archive
<span class="o">[</span>INFO] <span class="nt">------------------------------------------------------------------------</span>
<span class="o">[</span>INFO] BUILD SUCCESS
<span class="o">[</span>INFO] <span class="nt">------------------------------------------------------------------------</span>
<span class="o">[</span>INFO] Total <span class="nb">time</span>:  30.843 s
<span class="o">[</span>INFO] Finished at: 2022-09-11T19:44:18Z
<span class="o">[</span>INFO] <span class="nt">------------------------------------------------------------------------</span>
Removing intermediate container f5f06740c57a
 <span class="nt">---</span><span class="o">&gt;</span> 34e9da840534
Step 6/7 : CMD <span class="o">[</span><span class="s2">"java"</span>, <span class="s2">"-jar"</span>, <span class="s2">"target/spring-0.0.1-SNAPSHOT.jar"</span><span class="o">]</span>
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>5f29b55a0fdc
Removing intermediate container 5f29b55a0fdc
 <span class="nt">---</span><span class="o">&gt;</span> e299d92bd2e6
Step 7/7 : EXPOSE 8080
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>12b33cccbf0e
Removing intermediate container 12b33cccbf0e
 <span class="nt">---</span><span class="o">&gt;</span> e5b2b8c5644d
Successfully built e5b2b8c5644d
Successfully tagged java_springv1:latest##
</code></pre></div></div>

<blockquote>
  <p>Run docker-compose</p>
  <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose up <span class="nt">-d</span>
Recreating spring_portfolio_web_1 ... <span class="k">done</span>
</code></pre></div>  </div>
</blockquote>

<blockquote>
  <p>Now server is up, test in Browser for recent change</p>
  <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>Java Home Page
</code></pre></div>  </div>
</blockquote>

<h3 id="setting-up-automatic-deployment">
<a class="anchor" href="#setting-up-automatic-deployment" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setting up automatic deployment</h3>
<ul>
  <li>This is how to do autoamtic deployment using GitHub actions, which can run code after a push is made.</li>
  <li>First, a secret will need to be set up for your SSH key, in the Repository Settings &gt; Secrets create a new secret called SSH_KEY</li>
  <li>This secret should contain the output of <code class="language-plaintext highlighter-rouge">base64 -w 0 yourkeyfile.pem</code> (this enccodes the key to ensure it uses ASCII characters)</li>
  <li>GitHub Actions can be specified in the .github/workflows directory. In your repository create a file called .github/workflows/workflow.yml with the following content (this decodes the base64 key and then pulls code, builds docker container, and puts docker container up through SSH)
    <div class="language-yml highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s">Deploy to Server</span>
<span class="na">on</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">push</span><span class="pi">]</span>
<span class="na">jobs</span><span class="pi">:</span>
<span class="na">AWS-Deploy</span><span class="pi">:</span>
  <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
  <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">echo $ | base64 -d &gt; key.pem</span>
    <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">chmod 400 key.pem</span>
    <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">ssh -i key.pem -o StrictHostKeyChecking=no ubuntu@{your domain/ip} 'cd ~/projects/apcsa_spring; sudo git pull; sudo docker-compose build; sudo docker-compose down; sudo docker-compose up -d'</span>
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="faqs-for-problems">
<a class="anchor" href="#faqs-for-problems" aria-hidden="true"><span class="octicon octicon-link"></span></a>FAQS for Problems</h2>

<h3 id="setting-up-docker-without-sudo">
<a class="anchor" href="#setting-up-docker-without-sudo" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setting up docker without sudo</h3>
<ul>
  <li>Run the following commands to create a docker group &amp; add your user
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>groupadd docker
<span class="nb">sudo </span>usermod <span class="nt">-aG</span> docker <span class="nv">$USER</span>
</code></pre></div>    </div>
  </li>
  <li>May need to run the following commands if you previously used sudo (to giv3e yourself ownership of .docker)
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nb">sudo chown</span> <span class="s2">"</span><span class="nv">$USER</span><span class="s2">"</span>:<span class="s2">"</span><span class="nv">$USER</span><span class="s2">"</span> /home/<span class="s2">"</span><span class="nv">$USER</span><span class="s2">"</span>/.docker <span class="nt">-R</span>
<span class="nb">sudo chmod </span>g+rwx <span class="s2">"</span><span class="nv">$HOME</span><span class="s2">/.docker"</span> <span class="nt">-R</span>
</code></pre></div>    </div>
  </li>
  <li>For more information refer <a href="https://docs.docker.com/engine/install/linux-postinstall/">here</a>
</li>
</ul>

<h3 id="errors-on-docker-compose-or-curl">
<a class="anchor" href="#errors-on-docker-compose-or-curl" aria-hidden="true"><span class="octicon octicon-link"></span></a>Errors on docker-compose or curl</h3>
<blockquote>
  <p>if “docker-compose” or “curl” are not working and you want to start over.  This will clean up existing Docker container(s) and volume(s) and enable you to restart them.</p>
  <ul>
    <li>If any of these steps fail, try “sudo” prefix to elevate permissions.</li>
    <li>If commands are incomplete or something is missing, continue on.  These commands are intended to cleanup Docker, missing means it is already cleaned up.</li>
  </ul>
</blockquote>

<blockquote>
  <p>cd into your spring portfolio project</p>
  <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd</span> ~/project
</code></pre></div>  </div>
</blockquote>

<blockquote>
  <p>stop docker-compose processes</p>
  <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose down  <span class="c"># try sudo if it fails</span>
</code></pre></div>  </div>
</blockquote>

<blockquote>
  <p>Remove container</p>
  <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker ps  <span class="c"># list all containers</span>
<span class="nv">$ </span>docker <span class="nb">rm</span> <span class="nt">-f</span> container-name <span class="c"># try sudo if it fails</span>
</code></pre></div>  </div>
</blockquote>

<blockquote>
  <p>Remove volume</p>
  <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker volume <span class="nb">ls</span> <span class="c"># list all volumes</span>
<span class="nv">$ </span>docker volume <span class="nb">rm </span>volume-name <span class="c"># try sudo if it fails</span>
</code></pre></div>  </div>
</blockquote>

<blockquote>
  <p>Restart the containers using the following command</p>
  <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose up <span class="nt">-d</span> <span class="c"># try sudo if it fails</span>
</code></pre></div>  </div>
</blockquote>

<blockquote>
  <p>Use curl to test</p>
  <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://localhost:8085<span class="p">;</span>
</code></pre></div>  </div>
</blockquote>

  </div><a class="u-url" href="/RAYJ-final/techtalk/deploy" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/RAYJ-final/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/RAYJ-final/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/RAYJ-final/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>RAYJ Music</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/nighthawkcoders" target="_blank" title="nighthawkcoders"><svg class="svg-icon grey"><use xlink:href="/RAYJ-final/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/NighthawkCoding" target="_blank" title="NighthawkCoding"><svg class="svg-icon grey"><use xlink:href="/RAYJ-final/assets/minima-social-icons.svg#twitter"></use></svg></a></li><li><a rel="me" href="https://www.youtube.com/channel/UClIKOsDS5dsfzFA3zveDT3Q" target="_blank" title="YouTube"><svg class="svg-icon grey"><use xlink:href="/RAYJ-final/assets/minima-social-icons.svg#youtube"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
